#!/bin/bash

################################################################################
# Professional Web Penetration Testing Framework - Standalone Installer
# Vers√£o: 2.0
# Criado por: BUCH CTF Team
# 
# Este script instala e configura automaticamente o framework de pentest
# em qualquer sistema Kali Linux (ou Debian/Ubuntu).
################################################################################

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Vari√°veis
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_DIR="$SCRIPT_DIR"
VENV_DIR="$FRAMEWORK_DIR/venv"
TOOLS_DIR="$FRAMEWORK_DIR/tools"
OUTPUT_DIR="$FRAMEWORK_DIR/output"
GO_VERSION="1.21.5"
GO_BIN="$HOME/go/bin"

# Fun√ß√µes de output
print_banner() {
    echo -e "${GREEN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                                                                            ‚ïë"
    echo "‚ïë     üîí Professional Web Penetration Testing Framework v2.0 üîí            ‚ïë"
    echo "‚ïë                                                                            ‚ïë"
    echo "‚ïë                    Standalone Installer & Runner                          ‚ïë"
    echo "‚ïë                    Created by BUCH CTF Team                                ‚ïë"
    echo "‚ïë                                                                            ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

print_section() {
    echo -e "\n${CYAN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${CYAN}${BOLD}  $1${NC}"
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}\n"
}

print_step() {
    echo -e "${BLUE}[*]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[‚úì]${NC} $1"
}

print_error() {
    echo -e "${RED}[‚úó]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[‚ö†]${NC} $1"
}

print_info() {
    echo -e "${CYAN}[‚Ñπ]${NC} $1"
}

# Verificar se est√° rodando como root
check_root() {
    if [ "$EUID" -eq 0 ]; then 
        print_warning "N√£o execute este script como root!"
        print_info "Execute como usu√°rio normal. O script pedir√° senha quando necess√°rio."
        exit 1
    fi
}

# Verificar sistema operacional
check_os() {
    print_step "Verificando sistema operacional..."
    
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VER=$VERSION_ID
        print_success "Sistema detectado: $OS $VER"
        
        if [[ "$OS" != "kali" && "$OS" != "debian" && "$OS" != "ubuntu" ]]; then
            print_warning "Sistema n√£o √© Kali/Debian/Ubuntu. Algumas funcionalidades podem n√£o funcionar."
            read -p "Continuar mesmo assim? (s/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[SsYy]$ ]]; then
                exit 1
            fi
        fi
    else
        print_error "N√£o foi poss√≠vel detectar o sistema operacional"
        exit 1
    fi
}

# Atualizar sistema
update_system() {
    print_section "Atualizando Sistema"
    print_step "Atualizando lista de pacotes..."
    sudo apt update -qq
    
    print_step "Instalando depend√™ncias base..."
    sudo apt install -y -qq \
        curl \
        wget \
        git \
        build-essential \
        python3 \
        python3-pip \
        python3-venv \
        software-properties-common \
        apt-transport-https \
        ca-certificates \
        gnupg \
        lsb-release \
        > /dev/null 2>&1
    
    print_success "Sistema atualizado e depend√™ncias base instaladas"
}

# Instalar Go
install_go() {
    print_section "Instalando Go"
    
    if command -v go &> /dev/null; then
        GO_VER=$(go version | awk '{print $3}' | sed 's/go//')
        print_success "Go j√° instalado: $GO_VER"
        return
    fi
    
    print_step "Baixando Go $GO_VERSION..."
    cd /tmp
    GO_TAR="go${GO_VERSION}.linux-amd64.tar.gz"
    
    if [ ! -f "$GO_TAR" ]; then
        wget -q --show-progress "https://go.dev/dl/$GO_TAR"
    fi
    
    print_step "Instalando Go..."
    sudo rm -rf /usr/local/go
    sudo tar -C /usr/local -xzf "$GO_TAR" > /dev/null 2>&1
    
    # Adicionar ao PATH
    if ! grep -q '/usr/local/go/bin' ~/.bashrc; then
        echo '' >> ~/.bashrc
        echo '# Go paths' >> ~/.bashrc
        echo 'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin' >> ~/.bashrc
    fi
    
    export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    
    print_success "Go instalado com sucesso"
    rm -f "$GO_TAR"
    cd "$FRAMEWORK_DIR"
}

# Instalar ferramentas APT
install_apt_tools() {
    print_section "Instalando Ferramentas via APT"
    
    APT_TOOLS=(
        "nmap"
        "masscan"
        "nikto"
        "sqlmap"
        "hydra"
        "whatweb"
        "git"
        "curl"
        "wget"
    )
    
    for tool in "${APT_TOOLS[@]}"; do
        if command -v "$tool" &> /dev/null; then
            print_success "$tool j√° instalado"
        else
            print_step "Instalando $tool..."
            sudo apt install -y -qq "$tool" > /dev/null 2>&1
            print_success "$tool instalado"
        fi
    done
}

# Instalar ferramentas Go
install_go_tools() {
    print_section "Instalando Ferramentas Go"
    
    # Garantir que Go est√° no PATH
    export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    
    GO_TOOLS=(
        "github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
        "github.com/projectdiscovery/httpx/cmd/httpx@latest"
        "github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest"
        "github.com/projectdiscovery/katana/cmd/katana@latest"
        "github.com/tomnomnom/waybackurls@latest"
        "github.com/lc/gau/v2/cmd/gau@latest"
        "github.com/hahwul/dalfox/v2@latest"
        "github.com/tomnomnom/assetfinder@latest"
        "github.com/ffuf/ffuf@latest"
    )
    
    TOOL_NAMES=(
        "nuclei"
        "httpx"
        "subfinder"
        "katana"
        "waybackurls"
        "gau"
        "dalfox"
        "assetfinder"
        "ffuf"
    )
    
    for i in "${!GO_TOOLS[@]}"; do
        tool="${GO_TOOLS[$i]}"
        name="${TOOL_NAMES[$i]}"
        
        if command -v "$name" &> /dev/null; then
            print_success "$name j√° instalado"
        else
            print_step "Instalando $name..."
            go install -v "$tool" > /dev/null 2>&1 || {
                print_warning "Falha ao instalar $name, tentando novamente..."
                go install -v "$tool" 2>&1 | tail -5
            }
            
            # Copiar para /usr/local/bin se necess√°rio
            if [ -f "$GO_BIN/$name" ]; then
                sudo cp "$GO_BIN/$name" /usr/local/bin/ 2>/dev/null || true
            fi
            
            print_success "$name instalado"
        fi
    done
    
    # Atualizar templates do Nuclei
    if command -v nuclei &> /dev/null; then
        print_step "Atualizando templates do Nuclei..."
        nuclei -update-templates -silent > /dev/null 2>&1 || true
        print_success "Templates do Nuclei atualizados"
    fi
}

# Instalar ferramentas Python
install_python_tools() {
    print_section "Instalando Ferramentas Python"
    
    PYTHON_TOOLS=(
        "arjun"
    )
    
    for tool in "${PYTHON_TOOLS[@]}"; do
        if command -v "$tool" &> /dev/null; then
            print_success "$tool j√° instalado"
        else
            print_step "Instalando $tool..."
            pip3 install -q "$tool" > /dev/null 2>&1
            print_success "$tool instalado"
        fi
    done
}

# Instalar SecLists
install_seclists() {
    print_section "Instalando SecLists"
    
    if [ -d "/usr/share/seclists" ]; then
        print_success "SecLists j√° instalado"
        return
    fi
    
    if sudo apt install -y -qq seclists > /dev/null 2>&1; then
        print_success "SecLists instalado via apt"
    else
        print_step "Instalando SecLists do GitHub..."
        sudo git clone --depth 1 https://github.com/danielmiessler/SecLists.git /usr/share/seclists > /dev/null 2>&1
        print_success "SecLists instalado"
    fi
}

# Clonar reposit√≥rios Git
clone_git_repos() {
    print_section "Clonando Reposit√≥rios Git"
    
    mkdir -p "$TOOLS_DIR"
    
    GIT_REPOS=(
        "https://github.com/maurosoria/dirsearch.git:dirsearch"
        "https://github.com/commixproject/commix.git:commix"
        "https://github.com/ticarpi/jwt_tool.git:jwt_tool"
    )
    
    for repo_info in "${GIT_REPOS[@]}"; do
        IFS=':' read -r repo name <<< "$repo_info"
        repo_path="$TOOLS_DIR/$name"
        
        if [ -d "$repo_path" ]; then
            print_success "$name j√° clonado"
        else
            print_step "Clonando $name..."
            git clone --depth 1 "$repo" "$repo_path" > /dev/null 2>&1
            
            # Instalar requirements se existir
            if [ -f "$repo_path/requirements.txt" ]; then
                print_step "Instalando requirements para $name..."
                pip3 install -q -r "$repo_path/requirements.txt" > /dev/null 2>&1 || true
            fi
            
            print_success "$name clonado"
        fi
    done
}

# Criar ambiente virtual Python
setup_venv() {
    print_section "Configurando Ambiente Virtual Python"
    
    if [ -d "$VENV_DIR" ]; then
        print_success "Ambiente virtual j√° existe"
    else
        print_step "Criando ambiente virtual..."
        python3 -m venv "$VENV_DIR" > /dev/null 2>&1
        print_success "Ambiente virtual criado"
    fi
    
    print_step "Ativando ambiente virtual e instalando depend√™ncias..."
    source "$VENV_DIR/bin/activate"
    
    # Atualizar pip
    pip install --upgrade pip -q > /dev/null 2>&1
    
    # Instalar depend√™ncias Python
    if [ -f "$FRAMEWORK_DIR/requirements.txt" ]; then
        print_step "Instalando depend√™ncias Python..."
        pip install -q -r "$FRAMEWORK_DIR/requirements.txt" > /dev/null 2>&1
        print_success "Depend√™ncias Python instaladas"
    fi
}

# Verificar instala√ß√£o
verify_installation() {
    print_section "Verificando Instala√ß√£o"
    
    MISSING_TOOLS=()
    
    # Verificar ferramentas essenciais
    ESSENTIAL_TOOLS=("nuclei" "httpx" "subfinder" "nmap")
    
    for tool in "${ESSENTIAL_TOOLS[@]}"; do
        if command -v "$tool" &> /dev/null; then
            print_success "$tool ‚úì"
        else
            print_error "$tool ‚úó"
            MISSING_TOOLS+=("$tool")
        fi
    done
    
    if [ ${#MISSING_TOOLS[@]} -eq 0 ]; then
        print_success "Todas as ferramentas essenciais est√£o instaladas!"
        return 0
    else
        print_warning "Algumas ferramentas est√£o faltando: ${MISSING_TOOLS[*]}"
        return 1
    fi
}

# Fun√ß√£o de instala√ß√£o completa
install_all() {
    print_banner
    
    check_root
    check_os
    update_system
    install_go
    install_apt_tools
    install_go_tools
    install_python_tools
    install_seclists
    clone_git_repos
    setup_venv
    
    if verify_installation; then
        print_section "Instala√ß√£o Completa!"
        print_success "Framework instalado com sucesso!"
        echo ""
        print_info "Para usar o framework, execute:"
        echo -e "${GREEN}  ./pentest.sh -u https://target.com --recon${NC}"
        echo ""
        print_info "Ou ative o ambiente virtual e use diretamente:"
        echo -e "${GREEN}  source venv/bin/activate${NC}"
        echo -e "${GREEN}  python3 main.py -u https://target.com --full${NC}"
    else
        print_error "Instala√ß√£o conclu√≠da com alguns problemas"
        print_info "Algumas ferramentas podem precisar ser instaladas manualmente"
    fi
}

# Fun√ß√£o para executar scan
run_scan() {
    # Ativar ambiente virtual se existir
    if [ -d "$VENV_DIR" ]; then
        source "$VENV_DIR/bin/activate"
    else
        print_error "Ambiente virtual n√£o encontrado. Execute: ./pentest.sh --install"
        exit 1
    fi
    
    # Verificar se main.py existe
    if [ ! -f "$FRAMEWORK_DIR/main.py" ]; then
        print_error "main.py n√£o encontrado em $FRAMEWORK_DIR"
        exit 1
    fi
    
    # Executar scan
    cd "$FRAMEWORK_DIR"
    python3 main.py "$@"
}

# Fun√ß√£o de ajuda
show_help() {
    print_banner
    echo -e "${BOLD}Uso:${NC}"
    echo "  ./pentest.sh [OP√á√ïES]"
    echo ""
    echo -e "${BOLD}Op√ß√µes:${NC}"
    echo "  --install              Instalar todas as ferramentas e depend√™ncias"
    echo "  --check                Verificar instala√ß√£o"
    echo "  --update               Atualizar ferramentas e templates"
    echo "  -u, --url URL          Target URL"
    echo "  -d, --domain DOMAIN    Target domain"
    echo "  --full                 Scan completo"
    echo "  --recon                Apenas reconhecimento"
    echo "  --subdomains           Enumera√ß√£o de subdom√≠nios"
    echo "  --vuln                 Scan de vulnerabilidades"
    echo "  --ports                Port scanning"
    echo "  --crawl                Web crawling"
    echo "  --fuzz                 Directory fuzzing"
    echo "  --wordpress            WordPress scan"
    echo "  -o, --output DIR       Diret√≥rio de sa√≠da"
    echo "  -v, --verbose          Modo verbose"
    echo "  -h, --help             Mostrar esta ajuda"
    echo ""
    echo -e "${BOLD}Exemplos:${NC}"
    echo "  ./pentest.sh --install"
    echo "  ./pentest.sh -u https://target.com --recon"
    echo "  ./pentest.sh -d target.com --subdomains"
    echo "  ./pentest.sh -u https://target.com --full -o ./results"
    echo "  ./pentest.sh -u https://target.com --vuln --nuclei-tags cve,exposure"
    echo ""
}

# Fun√ß√£o de atualiza√ß√£o
update_tools() {
    print_section "Atualizando Ferramentas"
    
    # Atualizar sistema
    print_step "Atualizando sistema..."
    sudo apt update -qq
    sudo apt upgrade -y -qq > /dev/null 2>&1
    
    # Atualizar Go tools
    if command -v go &> /dev/null; then
        export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
        print_step "Atualizando ferramentas Go..."
        go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest > /dev/null 2>&1
        go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest > /dev/null 2>&1
        go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest > /dev/null 2>&1
        
        # Atualizar templates do Nuclei
        if command -v nuclei &> /dev/null; then
            print_step "Atualizando templates do Nuclei..."
            nuclei -update-templates -silent > /dev/null 2>&1
        fi
    fi
    
    # Atualizar reposit√≥rios Git
    print_step "Atualizando reposit√≥rios Git..."
    for dir in "$TOOLS_DIR"/*; do
        if [ -d "$dir/.git" ]; then
            (cd "$dir" && git pull -q > /dev/null 2>&1 || true)
        fi
    done
    
    # Atualizar depend√™ncias Python
    if [ -d "$VENV_DIR" ]; then
        print_step "Atualizando depend√™ncias Python..."
        source "$VENV_DIR/bin/activate"
        pip install --upgrade pip -q > /dev/null 2>&1
        if [ -f "$FRAMEWORK_DIR/requirements.txt" ]; then
            pip install -q -r "$FRAMEWORK_DIR/requirements.txt" --upgrade > /dev/null 2>&1
        fi
    fi
    
    print_success "Ferramentas atualizadas!"
}

# Main
main() {
    # Se n√£o houver argumentos, mostrar ajuda
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    # Processar argumentos
    case "$1" in
        --install|-i)
            install_all
            ;;
        --check|-c)
            verify_installation
            ;;
        --update|-u)
            update_tools
            ;;
        --help|-h)
            show_help
            ;;
        *)
            # Se n√£o for uma op√ß√£o especial, passar para o scan
            run_scan "$@"
            ;;
    esac
}

# Executar main
main "$@"

