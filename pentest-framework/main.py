#!/usr/bin/env python3
"""
Professional Web Penetration Testing Framework
Integra ferramentas externas através de Python
"""

import argparse
import sys
from pathlib import Path

# Adicionar diretório raiz ao path
sys.path.insert(0, str(Path(__file__).parent))

from core.installer import ToolInstaller
from core.tool_manager import ToolManager
from core.scanner import PentestScanner
from core.colors import Colors, print_banner


def parse_args():
    parser = argparse.ArgumentParser(
        description='Framework Profissional de Pentest Web',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Exemplos de uso:

  # Instalar ferramentas
  python3 main.py --install
  
  # Scan completo
  python3 main.py -u https://target.com --full
  
  # Apenas reconhecimento
  python3 main.py -u https://target.com --recon
  
  # Enumeração de subdomínios
  python3 main.py -d target.com --subdomains
  
  # WordPress scan
  python3 main.py -u https://wp-site.com --wordpress
  
  # Vulnerabilidades com Nuclei
  python3 main.py -u https://target.com --vuln --nuclei-tags cve,exposure
  
  # Port scanning
  python3 main.py -u target.com --ports
  
  # Directory fuzzing
  python3 main.py -u https://target.com --fuzz -w /path/to/wordlist.txt
        '''
    )
    
    # Installation
    parser.add_argument(
        '--install',
        action='store_true',
        help='Verificar e instalar todas as ferramentas necessárias'
    )
    
    # Target
    target_group = parser.add_mutually_exclusive_group(required=False)
    target_group.add_argument('-u', '--url', help='Target URL')
    target_group.add_argument('-d', '--domain', help='Target domain')
    target_group.add_argument('-l', '--list', help='File com lista de targets')
    
    # Scan modes
    parser.add_argument('--full', action='store_true', help='Scan completo (todos módulos)')
    parser.add_argument('--recon', action='store_true', help='Apenas reconhecimento')
    parser.add_argument('--subdomains', action='store_true', help='Enumeração de subdomínios')
    parser.add_argument('--crawl', action='store_true', help='Web crawling')
    parser.add_argument('--fuzz', action='store_true', help='Directory fuzzing')
    parser.add_argument('--wordpress', action='store_true', help='WordPress scan')
    parser.add_argument('--vuln', action='store_true', help='Vulnerability scan (Nuclei)')
    parser.add_argument('--ports', action='store_true', help='Port scanning')
    
    # Specific tests
    parser.add_argument('--xss', action='store_true', help='XSS testing')
    parser.add_argument('--sqli', action='store_true', help='SQL injection testing')
    parser.add_argument('--params', action='store_true', help='Parameter discovery')
    
    # Options
    parser.add_argument('-t', '--threads', type=int, default=10, help='Número de threads (padrão: 10)')
    parser.add_argument('--timeout', type=int, default=10, help='Timeout em segundos (padrão: 10)')
    parser.add_argument('-o', '--output', help='Diretório de saída')
    parser.add_argument('--format', choices=['json', 'html', 'pdf', 'all'], default='html', 
                       help='Formato do relatório (padrão: html)')
    parser.add_argument('-v', '--verbose', action='store_true', help='Modo verbose')
    parser.add_argument('--silent', action='store_true', help='Modo silencioso')
    
    # Nuclei options
    parser.add_argument('--nuclei-tags', help='Nuclei tags (separadas por vírgula)')
    parser.add_argument('--nuclei-severity', help='Nuclei severity (separadas por vírgula)')
    
    # Wordlists
    parser.add_argument('-w', '--wordlist', help='Wordlist customizada')
    parser.add_argument('--seclists', default='/usr/share/seclists', help='Caminho do SecLists')
    
    return parser.parse_args()


def check_python_version():
    """Verifica se a versão do Python é compatível"""
    if sys.version_info < (3, 7):
        print(f"{Colors.error('Python 3.7+ é necessário')}")
        print(f"{Colors.info(f'Versão atual: {sys.version}')}")
        sys.exit(1)


def main():
    # Verificar versão do Python
    check_python_version()
    
    # Parsear argumentos
    args = parse_args()
    
    # Banner
    if not args.silent:
        print_banner()
    
    # Installer
    installer = ToolInstaller()
    
    # Se --install, apenas instalar e sair
    if args.install:
        installer.check_and_install_all()
        print(f"\n{Colors.success('Instalação concluída!')}")
        print(f"{Colors.info('Execute novamente sem --install para começar o pentest')}\n")
        return 0
    
    # Verificar se target foi especificado
    if not (args.url or args.domain or args.list):
        print(f"{Colors.error('Erro: Especifique um target (-u, -d, ou -l)')}")
        print(f"{Colors.info('Use --help para mais informações')}\n")
        return 1
    
    # Verificar ferramentas essenciais
    if not args.silent:
        print(f"\n{Colors.info('Verificando ferramentas essenciais...')}")
        tools_ok, missing = installer.verify_core_tools()
        
        if not tools_ok:
            missing_str = ', '.join(missing)
            print(f"{Colors.warning(f'Ferramentas faltando: {missing_str}')}")
            print(f"{Colors.info('Execute: python3 main.py --install')}")
            
            response = input(f"\n{Colors.YELLOW}Continuar mesmo assim? (s/N): {Colors.RESET}")
            if response.lower() not in ['s', 'y', 'sim', 'yes']:
                return 1
        else:
            print(f"{Colors.success('Ferramentas essenciais OK')}")
    
    # Inicializar tool manager e scanner
    tool_manager = ToolManager(installer)
    scanner = PentestScanner(tool_manager, args)
    
    # Executar scan
    try:
        scanner.run()
        return 0
        
    except KeyboardInterrupt:
        print(f"\n\n{Colors.warning('Scan interrompido pelo usuário')}")
        return 130
        
    except Exception as e:
        print(f"\n{Colors.error(f'Erro: {e}')}")
        if args.verbose:
            import traceback
            traceback.print_exc()
        return 1


if __name__ == '__main__':
    sys.exit(main())

