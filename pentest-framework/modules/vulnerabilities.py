"""
Módulo de scanning de vulnerabilidades usando Nuclei.
"""

from typing import Dict, List, Any, Optional
from core.tool_manager import ToolManager
from core.colors import Colors
from core.progress import ProgressDisplay


class VulnerabilityScanner:
    """Scanner de vulnerabilidades"""
    
    def __init__(self, tool_manager: ToolManager, progress: Optional[ProgressDisplay] = None):
        self.tm = tool_manager
        self.progress = progress or ProgressDisplay()
        self.results = {
            'critical': [],
            'high': [],
            'medium': [],
            'low': [],
            'info': []
        }
    
    def scan(
        self,
        target: str,
        tags: Optional[List[str]] = None,
        severity: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """Executa scan de vulnerabilidades com Nuclei"""
        print(f"\n{Colors.BLUE}[*] Scanning vulnerabilidades com Nuclei...{Colors.RESET}")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        if not severity:
            severity = ['critical', 'high', 'medium']
        
        if not tags:
            tags = ['cve', 'exposure', 'misconfig', 'lfi', 'xss', 'sqli']
        
        print(f"{Colors.YELLOW}  ├── Tags: {', '.join(tags)}{Colors.RESET}")
        print(f"{Colors.YELLOW}  ├── Severity: {', '.join(severity)}{Colors.RESET}")
        
        # Executar Nuclei
        print(f"{Colors.YELLOW}  ├── Executando Nuclei...{Colors.RESET}")
        findings = self.tm.run_nuclei(
            target=target,
            tags=tags,
            severity=severity
        )
        
        # Organizar por severidade
        for finding in findings:
            info = finding.get('info', {})
            sev = info.get('severity', 'info').lower()
            
            vuln = {
                'name': info.get('name', 'Unknown'),
                'severity': sev,
                'template': finding.get('template-id', ''),
                'matched_at': finding.get('matched-at', target),
                'description': info.get('description', ''),
                'reference': info.get('reference', [])
            }
            
            if sev in self.results:
                self.results[sev].append(vuln)
        
        # Resumo visual melhorado
        self.progress.print_severity_summary(self.results)
        
        # Mostrar vulnerabilidades críticas e altas em tabela
        critical_high = self.results['critical'] + self.results['high']
        if critical_high:
            rows = []
            for vuln in critical_high[:10]:
                severity = vuln.get('severity', 'info').upper()
                rows.append([
                    severity,
                    vuln.get('name', 'Unknown')[:40],
                    vuln.get('matched_at', '')[:50]
                ])
            
            self.progress.print_table(
                headers=['Severity', 'Nome', 'URL'],
                rows=rows,
                title="⚠ Vulnerabilidades Críticas e Altas"
            )
        
        return self.results

