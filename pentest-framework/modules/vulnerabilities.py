"""
Módulo de scanning de vulnerabilidades usando Nuclei.
"""

from typing import Dict, List, Any, Optional
from core.tool_manager import ToolManager
from core.colors import Colors


class VulnerabilityScanner:
    """Scanner de vulnerabilidades"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'critical': [],
            'high': [],
            'medium': [],
            'low': [],
            'info': []
        }
    
    def scan(
        self,
        target: str,
        tags: Optional[List[str]] = None,
        severity: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """Executa scan de vulnerabilidades com Nuclei"""
        print(f"\n{Colors.BLUE}[*] Scanning vulnerabilidades com Nuclei...{Colors.RESET}")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        if not severity:
            severity = ['critical', 'high', 'medium']
        
        if not tags:
            tags = ['cve', 'exposure', 'misconfig', 'lfi', 'xss', 'sqli']
        
        print(f"{Colors.YELLOW}  ├── Tags: {', '.join(tags)}{Colors.RESET}")
        print(f"{Colors.YELLOW}  ├── Severity: {', '.join(severity)}{Colors.RESET}")
        
        # Executar Nuclei
        print(f"{Colors.YELLOW}  ├── Executando Nuclei...{Colors.RESET}")
        findings = self.tm.run_nuclei(
            target=target,
            tags=tags,
            severity=severity
        )
        
        # Organizar por severidade
        for finding in findings:
            info = finding.get('info', {})
            sev = info.get('severity', 'info').lower()
            
            vuln = {
                'name': info.get('name', 'Unknown'),
                'severity': sev,
                'template': finding.get('template-id', ''),
                'matched_at': finding.get('matched-at', target),
                'description': info.get('description', ''),
                'reference': info.get('reference', [])
            }
            
            if sev in self.results:
                self.results[sev].append(vuln)
        
        # Resumo
        total = sum(len(v) for v in self.results.values())
        print(f"\n{Colors.YELLOW}  Vulnerabilidades encontradas:{Colors.RESET}")
        
        if self.results['critical']:
            print(f"{Colors.BRIGHT_RED}  ├── CRITICAL: {len(self.results['critical'])}{Colors.RESET}")
        if self.results['high']:
            print(f"{Colors.RED}  ├── HIGH: {len(self.results['high'])}{Colors.RESET}")
        if self.results['medium']:
            print(f"{Colors.YELLOW}  ├── MEDIUM: {len(self.results['medium'])}{Colors.RESET}")
        if self.results['low']:
            print(f"{Colors.GREEN}  ├── LOW: {len(self.results['low'])}{Colors.RESET}")
        if self.results['info']:
            print(f"{Colors.CYAN}  └── INFO: {len(self.results['info'])}{Colors.RESET}")
        
        if total == 0:
            print(f"{Colors.GREEN}  └── Nenhuma vulnerabilidade encontrada{Colors.RESET}")
        
        # Mostrar vulnerabilidades críticas
        if self.results['critical']:
            print(f"\n{Colors.BRIGHT_RED}  ⚠ VULNERABILIDADES CRÍTICAS:{Colors.RESET}")
            for vuln in self.results['critical'][:5]:
                print(f"    • {vuln['name']} [{vuln['template']}]")
                print(f"      → {vuln['matched_at']}")
        
        return self.results

