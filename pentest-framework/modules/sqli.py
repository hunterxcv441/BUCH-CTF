"""
Módulo de SQL Injection testing usando sqlmap.
"""

from typing import Dict, Any
from core.tool_manager import ToolManager
from core.colors import Colors


class SQLiScanner:
    """Scanner de SQL Injection"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'vulnerable': False,
            'injection_type': None,
            'details': {}
        }
    
    def scan(self, target: str, options: Dict[str, Any] = None) -> Dict[str, Any]:
        """Executa SQL injection testing"""
        print(f"\n{Colors.BLUE}[*] SQL Injection Testing...{Colors.RESET}")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        options = options or {'level': 1, 'risk': 1, 'threads': 5}
        
        print(f"{Colors.YELLOW}  ├── Level: {options.get('level', 1)}{Colors.RESET}")
        print(f"{Colors.YELLOW}  ├── Risk: {options.get('risk', 1)}{Colors.RESET}")
        print(f"{Colors.YELLOW}  ├── Executando SQLMap...{Colors.RESET}")
        print(f"{Colors.YELLOW}  ├── AVISO: Isso pode demorar...{Colors.RESET}")
        
        # Executar SQLMap
        sqlmap_results = self.tm.run_sqlmap(target, options)
        
        # Processar resultados
        self.results['vulnerable'] = sqlmap_results.get('vulnerable', False)
        self.results['injection_type'] = sqlmap_results.get('injection_type')
        self.results['details'] = sqlmap_results
        
        # Resumo
        if self.results['vulnerable']:
            print(f"{Colors.RED}  └── VULNERÁVEL A SQL INJECTION!{Colors.RESET}")
            if self.results['injection_type']:
                print(f"{Colors.RED}     Tipo: {self.results['injection_type']}{Colors.RESET}")
        else:
            print(f"{Colors.GREEN}  └── Não vulnerável a SQL Injection{Colors.RESET}")
        
        return self.results

