"""
Módulo de enumeração de subdomínios usando subfinder, amass, etc.
"""

from typing import List, Dict, Any
from core.tool_manager import ToolManager
from core.colors import Colors


class SubdomainScanner:
    """Scanner de subdomínios"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'subdomains': [],
            'active': [],
            'technologies': []
        }
    
    def scan(self, domain: str) -> Dict[str, Any]:
        """Executa scan completo de subdomínios"""
        print(f"\n{Colors.BLUE}[*] Enumerando subdomínios...{Colors.RESET}")
        
        # 1. Subfinder (passive)
        print(f"{Colors.YELLOW}  ├── Subfinder (passive)...{Colors.RESET}")
        subdomains = self.tm.run_subfinder(domain)
        self.results['subdomains'] = list(set(subdomains))
        print(f"{Colors.GREEN}  ├── Encontrados: {len(self.results['subdomains'])}{Colors.RESET}")
        
        # 2. Validar com httpx
        if self.results['subdomains']:
            print(f"{Colors.YELLOW}  ├── Validando com httpx...{Colors.RESET}")
            # Limitar para não demorar muito
            targets_to_check = self.results['subdomains'][:100]
            httpx_results = self.tm.run_httpx(targets_to_check)
            
            for result in httpx_results:
                self.results['active'].append({
                    'url': result.get('url'),
                    'status': result.get('status-code'),
                    'title': result.get('title'),
                    'tech': result.get('tech', []),
                    'cdn': result.get('cdn')
                })
            
            print(f"{Colors.GREEN}  └── Ativos: {len(self.results['active'])}{Colors.RESET}")
        
        return self.results

