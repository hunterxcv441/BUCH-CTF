"""
M√≥dulo de enumera√ß√£o de subdom√≠nios usando subfinder, amass, etc.
"""

from typing import List, Dict, Any, Optional
from core.tool_manager import ToolManager
from core.colors import Colors
from core.progress import ProgressDisplay


class SubdomainScanner:
    """Scanner de subdom√≠nios"""
    
    def __init__(self, tool_manager: ToolManager, progress: Optional[ProgressDisplay] = None):
        self.tm = tool_manager
        self.progress = progress or ProgressDisplay()
        self.results = {
            'subdomains': [],
            'active': [],
            'technologies': []
        }
    
    def scan(self, domain: str) -> Dict[str, Any]:
        """Executa scan completo de subdom√≠nios"""
        self.progress.print_step(f"Enumerando subdom√≠nios para {domain}", "running")
        
        # 1. Subfinder (passive)
        self.progress.print_step("Subfinder (passive enumeration)", "info")
        subdomains = self.tm.run_subfinder(domain)
        self.results['subdomains'] = list(set(subdomains))
        self.progress.print_step(f"Encontrados {len(self.results['subdomains'])} subdom√≠nios", "success")
        
        # 2. Validar com httpx
        if self.results['subdomains']:
            self.progress.print_step("Validando subdom√≠nios com httpx", "info")
            # Limitar para n√£o demorar muito
            targets_to_check = self.results['subdomains'][:100]
            httpx_results = self.tm.run_httpx(targets_to_check)
            
            for result in httpx_results:
                self.results['active'].append({
                    'url': result.get('url'),
                    'status': result.get('status-code'),
                    'title': result.get('title'),
                    'tech': result.get('tech', []),
                    'cdn': result.get('cdn')
                })
            
            self.progress.print_step(f"Validados: {len(self.results['active'])} ativos", "success")
            
            # Mostrar tabela de subdom√≠nios ativos
            if self.results['active']:
                rows = []
                for host in self.results['active'][:20]:
                    status = str(host.get('status', ''))
                    title = host.get('title', '')[:30] or 'N/A'
                    rows.append([host.get('url', ''), status, title])
                
                self.progress.print_table(
                    headers=['URL', 'Status', 'Title'],
                    rows=rows,
                    title="üåê Subdom√≠nios Ativos"
                )
        
        return self.results

