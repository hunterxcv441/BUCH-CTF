"""
Módulo de análise de JavaScript para encontrar endpoints, APIs, secrets.
"""

import re
from typing import Dict, Any, List
from core.colors import Colors
import requests


class JavaScriptAnalyzer:
    """Analisador de arquivos JavaScript"""
    
    def __init__(self):
        self.results = {
            'endpoints': [],
            'api_keys': [],
            'secrets': [],
            'comments': []
        }
        
        # Regex patterns
        self.patterns = {
            'endpoints': [
                r'["\']/(api|v1|v2|v3|rest|graphql)[^"\']*["\']',
                r'["\']https?://[^"\']+["\']',
            ],
            'api_keys': [
                r'api[_-]?key["\']?\s*[:=]\s*["\']([^"\']+)["\']',
                r'apikey["\']?\s*[:=]\s*["\']([^"\']+)["\']',
                r'access[_-]?token["\']?\s*[:=]\s*["\']([^"\']+)["\']',
            ],
            'aws_keys': [
                r'AKIA[0-9A-Z]{16}',
            ],
            'google_api': [
                r'AIza[0-9A-Za-z\-_]{35}',
            ],
            'secrets': [
                r'secret["\']?\s*[:=]\s*["\']([^"\']+)["\']',
                r'password["\']?\s*[:=]\s*["\']([^"\']+)["\']',
                r'token["\']?\s*[:=]\s*["\']([^"\']+)["\']',
            ]
        }
    
    def analyze_file(self, url: str) -> Dict[str, Any]:
        """Analisa um arquivo JavaScript"""
        try:
            response = requests.get(url, timeout=10)
            content = response.text
            
            return self.analyze_content(content)
        except Exception as e:
            print(f"  {Colors.error(f'Erro ao analisar {url}: {e}')}")
            return {}
    
    def analyze_content(self, content: str) -> Dict[str, Any]:
        """Analisa conteúdo JavaScript"""
        local_results = {
            'endpoints': [],
            'api_keys': [],
            'secrets': [],
            'comments': []
        }
        
        # Endpoints
        for pattern in self.patterns['endpoints']:
            matches = re.findall(pattern, content, re.IGNORECASE)
            local_results['endpoints'].extend(matches)
        
        # API Keys
        for pattern in self.patterns['api_keys']:
            matches = re.findall(pattern, content, re.IGNORECASE)
            local_results['api_keys'].extend(matches)
        
        # AWS Keys
        for pattern in self.patterns['aws_keys']:
            matches = re.findall(pattern, content)
            local_results['api_keys'].extend(matches)
        
        # Google API Keys
        for pattern in self.patterns['google_api']:
            matches = re.findall(pattern, content)
            local_results['api_keys'].extend(matches)
        
        # Secrets
        for pattern in self.patterns['secrets']:
            matches = re.findall(pattern, content, re.IGNORECASE)
            local_results['secrets'].extend(matches)
        
        # Comments
        comments = re.findall(r'//.*?$|/\*.*?\*/', content, re.MULTILINE | re.DOTALL)
        local_results['comments'] = [c.strip() for c in comments if len(c.strip()) > 10]
        
        return local_results
    
    def scan(self, js_files: List[str]) -> Dict[str, Any]:
        """Analisa múltiplos arquivos JavaScript"""
        print(f"\n{Colors.BLUE}[*] JavaScript Analysis...{Colors.RESET}")
        
        if not js_files:
            print(f"{Colors.warning('Nenhum arquivo JavaScript para analisar')}")
            return self.results
        
        print(f"{Colors.YELLOW}  ├── Arquivos a analisar: {len(js_files)}{Colors.RESET}")
        
        for js_file in js_files[:20]:  # Limitar para não demorar muito
            print(f"{Colors.YELLOW}  ├── Analisando: {js_file}{Colors.RESET}")
            
            file_results = self.analyze_file(js_file)
            
            # Agregar resultados
            for key in ['endpoints', 'api_keys', 'secrets', 'comments']:
                self.results[key].extend(file_results.get(key, []))
        
        # Remover duplicatas
        for key in ['endpoints', 'api_keys', 'secrets']:
            self.results[key] = list(set(self.results[key]))
        
        # Resumo
        print(f"{Colors.GREEN}  └── Análise completa{Colors.RESET}")
        print(f"{Colors.CYAN}     ├── Endpoints: {len(self.results['endpoints'])}{Colors.RESET}")
        print(f"{Colors.CYAN}     ├── API Keys: {len(self.results['api_keys'])}{Colors.RESET}")
        print(f"{Colors.CYAN}     └── Secrets: {len(self.results['secrets'])}{Colors.RESET}")
        
        # Mostrar discoveries críticos
        if self.results['api_keys']:
            print(f"\n{Colors.RED}  ⚠ API KEYS/SECRETS ENCONTRADOS:{Colors.RESET}")
            for key in self.results['api_keys'][:10]:
                print(f"    • {key}")
        
        return self.results

