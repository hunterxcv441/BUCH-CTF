"""
Módulo de reconhecimento básico usando httpx, whatweb.
"""

from typing import Dict, Any
from core.tool_manager import ToolManager
from core.colors import Colors


class ReconScanner:
    """Scanner de reconhecimento"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'url': None,
            'status_code': None,
            'title': None,
            'server': None,
            'technologies': [],
            'cdn': None,
            'headers': {}
        }
    
    def scan(self, target: str) -> Dict[str, Any]:
        """Executa scan de reconhecimento"""
        print(f"\n{Colors.BLUE}[*] Iniciando reconhecimento...{Colors.RESET}")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        self.results['url'] = target
        
        # 1. HTTPX - Basic info
        print(f"{Colors.YELLOW}  ├── Coletando informações HTTP...{Colors.RESET}")
        httpx_results = self.tm.run_httpx([target])
        
        if httpx_results:
            result = httpx_results[0]
            self.results['status_code'] = result.get('status-code')
            self.results['title'] = result.get('title')
            self.results['server'] = result.get('webserver')
            self.results['cdn'] = result.get('cdn')
            self.results['technologies'] = result.get('tech', [])
            
            print(f"{Colors.GREEN}  ├── Status: {self.results['status_code']}{Colors.RESET}")
            if self.results['title']:
                print(f"{Colors.GREEN}  ├── Title: {self.results['title']}{Colors.RESET}")
            if self.results['server']:
                print(f"{Colors.GREEN}  ├── Server: {self.results['server']}{Colors.RESET}")
            if self.results['cdn']:
                print(f"{Colors.GREEN}  ├── CDN: {self.results['cdn']}{Colors.RESET}")
        
        # 2. WhatWeb - Technology detection
        print(f"{Colors.YELLOW}  ├── Detectando tecnologias...{Colors.RESET}")
        whatweb_results = self.tm.run_whatweb(target)
        
        if whatweb_results:
            # Extrair tecnologias do whatweb
            if isinstance(whatweb_results, list) and whatweb_results:
                plugins = whatweb_results[0].get('plugins', {})
                for tech, info in plugins.items():
                    if tech not in self.results['technologies']:
                        self.results['technologies'].append(tech)
        
        if self.results['technologies']:
            print(f"{Colors.GREEN}  ├── Tecnologias: {', '.join(self.results['technologies'][:5])}{Colors.RESET}")
            if len(self.results['technologies']) > 5:
                print(f"{Colors.GREEN}  └── ... e mais {len(self.results['technologies']) - 5}{Colors.RESET}")
        
        print(f"{Colors.GREEN}  └── Reconhecimento completo{Colors.RESET}")
        
        return self.results

