"""
Módulo de reconhecimento básico usando httpx, whatweb.
"""

from typing import Dict, Any, Optional
from core.tool_manager import ToolManager
from core.colors import Colors
from core.progress import ProgressDisplay


class ReconScanner:
    """Scanner de reconhecimento"""
    
    def __init__(self, tool_manager: ToolManager, progress: Optional[ProgressDisplay] = None):
        self.tm = tool_manager
        self.progress = progress or ProgressDisplay()
        self.results = {
            'url': None,
            'status_code': None,
            'title': None,
            'server': None,
            'technologies': [],
            'cdn': None,
            'headers': {}
        }
    
    def scan(self, target: str) -> Dict[str, Any]:
        """Executa scan de reconhecimento"""
        self.progress.print_step(f"Iniciando reconhecimento de {target}", "running")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        self.results['url'] = target
        
        # 1. HTTPX - Basic info
        self.progress.print_step("Coletando informações HTTP (httpx)", "info")
        httpx_results = self.tm.run_httpx([target])
        
        if httpx_results:
            result = httpx_results[0]
            self.results['status_code'] = result.get('status-code')
            self.results['title'] = result.get('title')
            self.results['server'] = result.get('webserver')
            self.results['cdn'] = result.get('cdn')
            self.results['technologies'] = result.get('tech', [])
        
        # 200 <= self.results.get('status_code', 0) < 300:
            self.progress.print_step(f"Status: {self.results['status_code']} ✓", "success")
        else:
            self.progress.print_step(f"Status: {self.results.get('status_code', 'N/A')}", "warning")
        
        # 2. WhatWeb - Technology detection
        self.progress.print_step("Detectando tecnologias (whatweb)", "info")
        whatweb_results = self.tm.run_whatweb(target)
        
        if whatweb_results:
            # Extrair tecnologias do whatweb
            if isinstance(whatweb_results, list) and whatweb_results:
                plugins = whatweb_results[0].get('plugins', {})
                for tech, info in plugins.items():
                    if tech not in self.results['technologies']:
                        self.results['technologies'].append(tech)
        
        # Mostrar resultados em tabela
        info_rows = []
        if self.results['title']:
            info_rows.append(['Title', self.results['title'][:60]])
        if self.results['server']:
            info_rows.append(['Server', self.results['server']])
        if self.results['cdn']:
            info_rows.append(['CDN', self.results['cdn']])
        if self.results['technologies']:
            tech_str = ', '.join(self.results['technologies'][:10])
            if len(self.results['technologies']) > 10:
                tech_str += f" ... (+{len(self.results['technologies']) - 10} mais)"
            info_rows.append(['Technologies', tech_str])
        
        if info_rows:
            self.progress.print_table(
                headers=['Campo', 'Valor'],
                rows=info_rows,
                title="ℹ Informações do Target"
            )
        
        self.progress.print_step("Reconhecimento completo", "success")
        
        return self.results

