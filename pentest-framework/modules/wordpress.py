"""
Módulo de WordPress scanning usando wpscan.
"""

from typing import Dict, Any, Optional
from core.tool_manager import ToolManager
from core.colors import Colors


class WordPressScanner:
    """Scanner específico para WordPress"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'is_wordpress': False,
            'version': None,
            'theme': None,
            'plugins': [],
            'users': [],
            'vulnerabilities': []
        }
    
    def scan(self, target: str, api_token: Optional[str] = None) -> Dict[str, Any]:
        """Executa WordPress scan"""
        print(f"\n{Colors.BLUE}[*] WordPress Scanning...{Colors.RESET}")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        print(f"{Colors.YELLOW}  ├── Executando WPScan...{Colors.RESET}")
        
        # Executar WPScan
        wpscan_results = self.tm.run_wpscan(
            url=target,
            enumerate='vp,vt,u',
            api_token=api_token
        )
        
        if not wpscan_results:
            print(f"{Colors.error('WPScan não retornou resultados')}")
            return self.results
        
        # Verificar se é WordPress
        self.results['is_wordpress'] = 'version' in wpscan_results
        
        if not self.results['is_wordpress']:
            print(f"{Colors.warning('Site não parece ser WordPress')}")
            return self.results
        
        print(f"{Colors.GREEN}  ├── WordPress detectado!{Colors.RESET}")
        
        # Extrair versão
        version_info = wpscan_results.get('version', {})
        if version_info:
            self.results['version'] = version_info.get('number', 'Unknown')
            print(f"{Colors.GREEN}  ├── Versão: {self.results['version']}{Colors.RESET}")
        
        # Tema
        theme_info = wpscan_results.get('main_theme', {})
        if theme_info:
            self.results['theme'] = theme_info.get('slug', 'Unknown')
            print(f"{Colors.GREEN}  ├── Tema: {self.results['theme']}{Colors.RESET}")
        
        # Plugins
        plugins = wpscan_results.get('plugins', {})
        for plugin_slug, plugin_info in plugins.items():
            plugin_data = {
                'name': plugin_slug,
                'version': plugin_info.get('version', {}).get('number', 'Unknown')
            }
            self.results['plugins'].append(plugin_data)
        
        if self.results['plugins']:
            print(f"{Colors.GREEN}  ├── Plugins: {len(self.results['plugins'])}{Colors.RESET}")
        
        # Usuários
        users = wpscan_results.get('users', {})
        for user_id, user_info in users.items():
            self.results['users'].append(user_info.get('username', user_id))
        
        if self.results['users']:
            print(f"{Colors.GREEN}  ├── Usuários: {', '.join(self.results['users'])}{Colors.RESET}")
        
        # Vulnerabilidades
        vulns_found = False
        
        # Vulnerabilidades da versão
        if 'version' in wpscan_results and 'vulnerabilities' in wpscan_results['version']:
            for vuln in wpscan_results['version']['vulnerabilities']:
                self.results['vulnerabilities'].append({
                    'type': 'core',
                    'title': vuln.get('title', 'Unknown'),
                    'references': vuln.get('references', {})
                })
                vulns_found = True
        
        # Vulnerabilidades de plugins
        for plugin_slug, plugin_info in plugins.items():
            if 'vulnerabilities' in plugin_info:
                for vuln in plugin_info['vulnerabilities']:
                    self.results['vulnerabilities'].append({
                        'type': 'plugin',
                        'plugin': plugin_slug,
                        'title': vuln.get('title', 'Unknown'),
                        'references': vuln.get('references', {})
                    })
                    vulns_found = True
        
        if vulns_found:
            print(f"{Colors.RED}  └── Vulnerabilidades: {len(self.results['vulnerabilities'])}{Colors.RESET}")
            
            # Mostrar algumas vulnerabilidades
            print(f"\n{Colors.RED}  ⚠ VULNERABILIDADES ENCONTRADAS:{Colors.RESET}")
            for vuln in self.results['vulnerabilities'][:5]:
                vuln_type = vuln['type'].upper()
                if vuln['type'] == 'plugin':
                    print(f"    • [{vuln_type}] {vuln['plugin']}: {vuln['title']}")
                else:
                    print(f"    • [{vuln_type}] {vuln['title']}")
        else:
            print(f"{Colors.GREEN}  └── Nenhuma vulnerabilidade conhecida{Colors.RESET}")
        
        return self.results

