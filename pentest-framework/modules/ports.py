"""
Módulo de port scanning usando nmap, masscan.
"""

from typing import Dict, Any
from core.tool_manager import ToolManager
from core.colors import Colors


class PortScanner:
    """Scanner de portas"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'host': None,
            'ports': [],
            'services': {}
        }
    
    def scan(self, target: str, fast: bool = True) -> Dict[str, Any]:
        """Executa port scan"""
        print(f"\n{Colors.BLUE}[*] Port Scanning...{Colors.RESET}")
        
        # Remover protocolo se presente
        target = target.replace('https://', '').replace('http://', '').split('/')[0]
        self.results['host'] = target
        
        if fast:
            print(f"{Colors.YELLOW}  ├── Modo: Fast (top 100 portas){Colors.RESET}")
        else:
            print(f"{Colors.YELLOW}  ├── Modo: Completo (todas as portas){Colors.RESET}")
        
        # Executar Nmap
        print(f"{Colors.YELLOW}  ├── Executando Nmap...{Colors.RESET}")
        nmap_results = self.tm.run_nmap(
            target=target,
            fast=fast,
            service_detection=True
        )
        
        self.results['ports'] = nmap_results.get('ports', [])
        
        # Organizar serviços
        for port_info in self.results['ports']:
            service = port_info['service']
            if service not in self.results['services']:
                self.results['services'][service] = []
            self.results['services'][service].append(port_info['port'])
        
        # Resumo
        print(f"{Colors.GREEN}  └── Portas abertas: {len(self.results['ports'])}{Colors.RESET}")
        
        if self.results['ports']:
            print(f"\n{Colors.YELLOW}  Portas encontradas:{Colors.RESET}")
            for port in self.results['ports'][:20]:
                service_info = port['service']
                if port.get('version'):
                    service_info += f" ({port['version']})"
                print(f"    • {port['port']}/{port['protocol']} - {service_info}")
            
            if len(self.results['ports']) > 20:
                print(f"    ... e mais {len(self.results['ports']) - 20} portas")
        
        return self.results

