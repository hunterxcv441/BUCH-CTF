"""
MÃ³dulo de port scanning usando nmap, masscan.
"""

from typing import Dict, Any, Optional
from core.tool_manager import ToolManager
from core.colors import Colors
from core.progress import ProgressDisplay


class PortScanner:
    """Scanner de portas"""
    
    def __init__(self, tool_manager: ToolManager, progress: Optional[ProgressDisplay] = None):
        self.tm = tool_manager
        self.progress = progress or ProgressDisplay()
        self.results = {
            'host': None,
            'ports': [],
            'services': {}
        }
    
    def scan(self, target: str, fast: bool = True) -> Dict[str, Any]:
        """Executa port scan"""
        # Remover protocolo se presente
        target = target.replace('https://', '').replace('http://', '').split('/')[0]
        self.results['host'] = target
        
        mode_str = "Fast (top 100 portas)" if fast else "Completo (todas as portas)"
        self.progress.print_step(f"Port Scanning - Modo: {mode_str}", "running")
        
        # Executar Nmap
        self.progress.print_step("Executando Nmap...", "info")
        nmap_results = self.tm.run_nmap(
            target=target,
            fast=fast,
            service_detection=True
        )
        
        self.results['ports'] = nmap_results.get('ports', [])
        
        # Organizar serviÃ§os
        for port_info in self.results['ports']:
            service = port_info['service']
            if service not in self.results['services']:
                self.results['services'][service] = []
            self.results['services'][service].append(port_info['port'])
        
        self.progress.print_step(f"Encontradas {len(self.results['ports'])} portas abertas", "success")
        
        # Mostrar portas em tabela
        if self.results['ports']:
            rows = []
            for port in self.results['ports'][:30]:
                service_info = port['service']
                if port.get('version'):
                    service_info += f" ({port['version']})"
                rows.append([
                    f"{port['port']}/{port['protocol']}",
                    service_info,
                    port.get('state', 'open')
                ])
            
            self.progress.print_table(
                headers=['Porta', 'ServiÃ§o', 'Estado'],
                rows=rows,
                title="ðŸ”Œ Portas Abertas"
            )
            
            # Mostrar resumo por serviÃ§o
            if self.results['services']:
                service_rows = []
                for service, ports in sorted(self.results['services'].items(), key=lambda x: len(x[1]), reverse=True):
                    ports_str = ', '.join(ports[:5])
                    if len(ports) > 5:
                        ports_str += f" ... (+{len(ports) - 5})"
                    service_rows.append([service, str(len(ports)), ports_str])
                
                self.progress.print_table(
                    headers=['ServiÃ§o', 'Qtd', 'Portas'],
                    rows=service_rows[:10],
                    title="ðŸ“Š ServiÃ§os Detectados"
                )
        
        return self.results

