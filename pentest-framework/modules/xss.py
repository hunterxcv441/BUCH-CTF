"""
Módulo de XSS testing usando dalfox.
"""

from typing import Dict, Any, List
from core.tool_manager import ToolManager
from core.colors import Colors


class XSSScanner:
    """Scanner de Cross-Site Scripting (XSS)"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'vulnerable_urls': [],
            'total_tested': 0
        }
    
    def scan(self, urls: List[str]) -> Dict[str, Any]:
        """Executa XSS testing"""
        print(f"\n{Colors.BLUE}[*] XSS Testing...{Colors.RESET}")
        
        # Filtrar apenas URLs com parâmetros
        urls_with_params = [url for url in urls if '?' in url or '=' in url]
        
        if not urls_with_params:
            print(f"{Colors.warning('Nenhuma URL com parâmetros encontrada')}")
            # Tentar URL base
            urls_with_params = urls[:10] if urls else []
        
        self.results['total_tested'] = len(urls_with_params)
        
        if not urls_with_params:
            print(f"{Colors.error('Nenhuma URL para testar')}")
            return self.results
        
        print(f"{Colors.YELLOW}  ├── URLs a testar: {len(urls_with_params)}{Colors.RESET}")
        print(f"{Colors.YELLOW}  ├── Executando Dalfox...{Colors.RESET}")
        
        # Executar Dalfox
        dalfox_results = self.tm.run_dalfox(urls_with_params[:50])  # Limitar para não demorar muito
        
        # Processar resultados
        for result in dalfox_results:
            if result.get('type') == 'POC' or result.get('severity'):
                vuln_info = {
                    'url': result.get('url', ''),
                    'parameter': result.get('param', ''),
                    'payload': result.get('payload', ''),
                    'type': result.get('type', 'Unknown')
                }
                self.results['vulnerable_urls'].append(vuln_info)
        
        # Resumo
        if self.results['vulnerable_urls']:
            print(f"{Colors.RED}  └── Vulneráveis: {len(self.results['vulnerable_urls'])}{Colors.RESET}")
            
            print(f"\n{Colors.RED}  ⚠ URLs VULNERÁVEIS A XSS:{Colors.RESET}")
            for vuln in self.results['vulnerable_urls'][:10]:
                print(f"    • {vuln['url']}")
                if vuln['parameter']:
                    print(f"      → Parâmetro: {vuln['parameter']}")
        else:
            print(f"{Colors.GREEN}  └── Nenhuma vulnerabilidade XSS encontrada{Colors.RESET}")
        
        return self.results

