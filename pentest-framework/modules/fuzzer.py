"""
Módulo de directory/file fuzzing usando ffuf, dirsearch.
"""

from typing import Dict, Any, Optional
from pathlib import Path
from core.tool_manager import ToolManager
from core.colors import Colors
from core.utils import get_wordlist_path


class DirectoryFuzzer:
    """Scanner de diretórios e arquivos"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'directories': [],
            'files': [],
            'interesting': []
        }
    
    def scan(self, target: str, wordlist: Optional[str] = None) -> Dict[str, Any]:
        """Executa directory fuzzing"""
        print(f"\n{Colors.BLUE}[*] Directory Fuzzing...{Colors.RESET}")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        # Selecionar wordlist
        if not wordlist:
            wordlist = get_wordlist_path('common')
            if not wordlist:
                wordlist = get_wordlist_path('directories')
        
        if not wordlist or not Path(wordlist).exists():
            print(f"{Colors.warning('Nenhuma wordlist encontrada. Usando wordlist padrão do ffuf.')}")
            # Tentar wordlist comum do sistema
            common_paths = [
                '/usr/share/wordlists/dirb/common.txt',
                '/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt',
                '/usr/share/seclists/Discovery/Web-Content/common.txt'
            ]
            for path in common_paths:
                if Path(path).exists():
                    wordlist = path
                    break
        
        if not wordlist:
            print(f"{Colors.error('Nenhuma wordlist disponível. Pulando fuzzing.')}")
            return self.results
        
        print(f"{Colors.YELLOW}  ├── Usando wordlist: {wordlist}{Colors.RESET}")
        
        # 1. FFUF - Fast fuzzing
        print(f"{Colors.YELLOW}  ├── FFUF (fuzzing)...{Colors.RESET}")
        
        # Fuzzing de diretórios
        ffuf_results = self.tm.run_ffuf(
            url=target,
            wordlist=wordlist,
            extensions=['.php', '.html', '.txt', '.asp', '.aspx', '.jsp'],
            threads=50
        )
        
        # Processar resultados
        for result in ffuf_results:
            url = result.get('url', '')
            status = result.get('status', 0)
            size = result.get('length', 0)
            
            entry = {
                'url': url,
                'status': status,
                'size': size
            }
            
            # Classificar
            if url.endswith('/'):
                self.results['directories'].append(entry)
            else:
                self.results['files'].append(entry)
            
            # Identificar interessantes
            if status in [200, 301, 302, 401, 403]:
                interesting_keywords = [
                    'admin', 'login', 'api', 'config', 'backup',
                    'db', 'database', 'sql', 'test', 'dev'
                ]
                if any(keyword in url.lower() for keyword in interesting_keywords):
                    self.results['interesting'].append(entry)
        
        print(f"{Colors.GREEN}  └── Encontrado:{Colors.RESET}")
        print(f"{Colors.CYAN}     ├── Diretórios: {len(self.results['directories'])}{Colors.RESET}")
        print(f"{Colors.CYAN}     ├── Arquivos: {len(self.results['files'])}{Colors.RESET}")
        print(f"{Colors.CYAN}     └── Interessantes: {len(self.results['interesting'])}{Colors.RESET}")
        
        # Mostrar alguns interessantes
        if self.results['interesting']:
            print(f"\n{Colors.YELLOW}  Descobertas interessantes:{Colors.RESET}")
            for item in self.results['interesting'][:10]:
                print(f"    • [{item['status']}] {item['url']}")
        
        return self.results

