"""
M贸dulo de directory/file fuzzing usando ffuf, dirsearch.
"""

from typing import Dict, Any, Optional
from pathlib import Path
from core.tool_manager import ToolManager
from core.colors import Colors
from core.utils import get_wordlist_path
from core.progress import ProgressDisplay
from core.utils import get_wordlist_path


class DirectoryFuzzer:
    """Scanner de diret贸rios e arquivos"""
    
    def __init__(self, tool_manager: ToolManager, progress: Optional[ProgressDisplay] = None):
        self.tm = tool_manager
        self.progress = progress or ProgressDisplay()
        self.results = {
            'directories': [],
            'files': [],
            'interesting': []
        }
    
    def scan(self, target: str, wordlist: Optional[str] = None) -> Dict[str, Any]:
        """Executa directory fuzzing"""
        print(f"\n{Colors.BLUE}[*] Directory Fuzzing...{Colors.RESET}")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        # Selecionar wordlist
        if not wordlist:
            wordlist = get_wordlist_path('common')
            if not wordlist:
                wordlist = get_wordlist_path('directories')
        
        if not wordlist or not Path(wordlist).exists():
            print(f"{Colors.warning('Nenhuma wordlist encontrada. Usando wordlist padr茫o do ffuf.')}")
            # Tentar wordlist comum do sistema
            common_paths = [
                '/usr/share/wordlists/dirb/common.txt',
                '/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt',
                '/usr/share/seclists/Discovery/Web-Content/common.txt'
            ]
            for path in common_paths:
                if Path(path).exists():
                    wordlist = path
                    break
        
        if not wordlist:
            print(f"{Colors.error('Nenhuma wordlist dispon铆vel. Pulando fuzzing.')}")
            return self.results
        
        print(f"{Colors.YELLOW}   Usando wordlist: {wordlist}{Colors.RESET}")
        
        # 1. FFUF - Fast fuzzing
        print(f"{Colors.YELLOW}   FFUF (fuzzing)...{Colors.RESET}")
        
        # Fuzzing de diret贸rios
        ffuf_results = self.tm.run_ffuf(
            url=target,
            wordlist=wordlist,
            extensions=['.php', '.html', '.txt', '.asp', '.aspx', '.jsp'],
            threads=50
        )
        
        # Processar resultados
        for result in ffuf_results:
            url = result.get('url', '')
            status = result.get('status', 0)
            size = result.get('length', 0)
            
            entry = {
                'url': url,
                'status': status,
                'size': size
            }
            
            # Classificar
            if url.endswith('/'):
                self.results['directories'].append(entry)
            else:
                self.results['files'].append(entry)
            
            # Identificar interessantes
            if status in [200, 301, 302, 401, 403]:
                interesting_keywords = [
                    'admin', 'login', 'api', 'config', 'backup',
                    'db', 'database', 'sql', 'test', 'dev'
                ]
                if any(keyword in url.lower() for keyword in interesting_keywords):
                    self.results['interesting'].append(entry)
        
        self.progress.print_step(
            f"Encontrados: {len(self.results['directories'])} diret贸rios, "
            f"{len(self.results['files'])} arquivos, "
            f"{len(self.results['interesting'])} interessantes",
            "success"
        )
        
        # Mostrar descobertas interessantes em tabela
        if self.results['interesting']:
            rows = []
            for item in self.results['interesting'][:20]:
                rows.append([
                    str(item['status']),
                    item['url'],
                    f"{item.get('size', 0)} bytes"
                ])
            
            self.progress.print_table(
                headers=['Status', 'URL', 'Tamanho'],
                rows=rows,
                title=" Descobertas Interessantes"
            )
        
        # Mostrar alguns diret贸rios e arquivos
        if self.results['directories'] or self.results['files']:
            all_items = self.results['directories'][:10] + self.results['files'][:10]
            if all_items:
                rows = []
                for item in all_items[:15]:
                    item_type = " DIR" if item['url'].endswith('/') else " FILE"
                    rows.append([
                        item_type,
                        str(item['status']),
                        item['url']
                    ])
                
                self.progress.print_table(
                    headers=['Tipo', 'Status', 'Path'],
                    rows=rows,
                    title=" Diret贸rios e Arquivos Encontrados"
                )
        
        return self.results

