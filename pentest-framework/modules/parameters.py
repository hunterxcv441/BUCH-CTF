"""
Módulo de parameter discovery usando arjun.
"""

from typing import Dict, Any, List
from core.tool_manager import ToolManager
from core.colors import Colors


class ParameterScanner:
    """Scanner de parâmetros HTTP"""
    
    def __init__(self, tool_manager: ToolManager):
        self.tm = tool_manager
        self.results = {
            'parameters': [],
            'get': [],
            'post': []
        }
    
    def scan(self, target: str, methods: List[str] = None) -> Dict[str, Any]:
        """Executa parameter discovery"""
        print(f"\n{Colors.BLUE}[*] Parameter Discovery...{Colors.RESET}")
        
        # Garantir que target tem protocolo
        if not target.startswith('http'):
            target = f'https://{target}'
        
        methods = methods or ['GET', 'POST']
        
        for method in methods:
            print(f"{Colors.YELLOW}  ├── Testando método {method}...{Colors.RESET}")
            
            # Executar Arjun
            params = self.tm.run_arjun(target, method=method)
            
            if params:
                print(f"{Colors.GREEN}  ├── {method}: {len(params)} parâmetros{Colors.RESET}")
                
                if method == 'GET':
                    self.results['get'].extend(params)
                elif method == 'POST':
                    self.results['post'].extend(params)
                
                self.results['parameters'].extend(params)
        
        # Resumo
        self.results['parameters'] = list(set(self.results['parameters']))
        
        if self.results['parameters']:
            print(f"{Colors.GREEN}  └── Total: {len(self.results['parameters'])} parâmetros únicos{Colors.RESET}")
            
            print(f"\n{Colors.YELLOW}  Parâmetros encontrados:{Colors.RESET}")
            for param in self.results['parameters'][:20]:
                print(f"    • {param}")
        else:
            print(f"{Colors.YELLOW}  └── Nenhum parâmetro descoberto{Colors.RESET}")
        
        return self.results

