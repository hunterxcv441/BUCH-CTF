#!/bin/bash

################################################################################
# Script dedicado para instalar Arjun corretamente
# Versão: 1.0
################################################################################

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_step() {
    echo -e "${BLUE}[*]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[✓]${NC} $1"
}

print_error() {
    echo -e "${RED}[✗]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[⚠]${NC} $1"
}

echo ""
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  Instalador do Arjun - Parameter Discovery Tool${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo ""

# Verificar se já está instalado
if command -v arjun &> /dev/null; then
    print_success "Arjun já está instalado!"
    arjun --version
    exit 0
fi

# Método 1: pip3 com --user --break-system-packages (Kali Linux 2024+)
print_step "Tentando instalar via pip3 (método 1)..."
if pip3 install arjun --user --break-system-packages 2>/dev/null; then
    print_success "Arjun instalado via pip3!"
    export PATH="$PATH:$HOME/.local/bin"
    
    # Adicionar ao PATH permanentemente
    if ! grep -q "/.local/bin" ~/.bashrc; then
        echo 'export PATH="$PATH:$HOME/.local/bin"' >> ~/.bashrc
        print_success "PATH atualizado no ~/.bashrc"
    fi
    
    if command -v arjun &> /dev/null; then
        print_success "Arjun funcional!"
        arjun --version
        exit 0
    fi
fi

# Método 2: pip3 com --user (sistemas mais antigos)
print_step "Tentando instalar via pip3 (método 2)..."
if pip3 install arjun --user 2>/dev/null; then
    print_success "Arjun instalado via pip3!"
    export PATH="$PATH:$HOME/.local/bin"
    
    if command -v arjun &> /dev/null; then
        print_success "Arjun funcional!"
        arjun --version
        exit 0
    fi
fi

# Método 3: pipx
print_step "Tentando instalar via pipx..."
if ! command -v pipx &> /dev/null; then
    print_step "Instalando pipx primeiro..."
    sudo apt install -y pipx 2>/dev/null || pip3 install --user pipx
    pipx ensurepath
fi

if command -v pipx &> /dev/null; then
    if pipx install arjun 2>/dev/null; then
        print_success "Arjun instalado via pipx!"
        export PATH="$PATH:$HOME/.local/bin"
        
        if command -v arjun &> /dev/null; then
            print_success "Arjun funcional!"
            arjun --version
            exit 0
        fi
    fi
fi

# Método 4: Clonar repositório e instalar
print_step "Tentando instalar do GitHub..."
TEMP_DIR="/tmp/arjun_install_$$"
mkdir -p "$TEMP_DIR"
cd "$TEMP_DIR"

if git clone https://github.com/s0md3v/Arjun.git; then
    cd Arjun
    print_step "Instalando do código fonte..."
    
    if python3 setup.py install --user 2>/dev/null; then
        print_success "Arjun instalado do fonte!"
    else
        # Tentar executar diretamente
        print_step "Criando wrapper script..."
        sudo tee /usr/local/bin/arjun > /dev/null << 'EOF'
#!/bin/bash
python3 /tmp/arjun_install_*/Arjun/arjun.py "$@"
EOF
        sudo chmod +x /usr/local/bin/arjun
    fi
fi

# Limpar
cd - > /dev/null
# rm -rf "$TEMP_DIR"

# Verificação final
echo ""
if command -v arjun &> /dev/null; then
    print_success "Arjun instalado com sucesso!"
    echo ""
    print_step "Testando..."
    arjun --version || arjun -h | head -5
    echo ""
    print_success "Localização: $(which arjun)"
    exit 0
else
    print_error "Falha ao instalar Arjun por todos os métodos"
    echo ""
    print_warning "Soluções alternativas:"
    echo "  1. Instalar manualmente:"
    echo "     git clone https://github.com/s0md3v/Arjun"
    echo "     cd Arjun"
    echo "     python3 arjun.py --help"
    echo ""
    echo "  2. Usar Docker:"
    echo "     docker pull s0md3v/arjun"
    echo "     docker run -it s0md3v/arjun -u https://target.com"
    echo ""
    exit 1
fi

