"""
Sistema avan√ßado de visualiza√ß√£o de progresso e resultados.
"""

import sys
from typing import List, Dict, Any, Optional
from tqdm import tqdm
from datetime import datetime

from core.colors import Colors


class ProgressDisplay:
    """Gerencia visualiza√ß√£o de progresso e resultados"""
    
    def __init__(self, silent: bool = False):
        self.silent = silent
        self.current_module = None
        self.module_start_time = None
    
    def start_module(self, module_name: str):
        """Inicia visualiza√ß√£o de um m√≥dulo"""
        if self.silent:
            return
        
        self.current_module = module_name
        self.module_start_time = datetime.now()
        
        print(f"\n{Colors.CYAN}{'‚ïê'*70}{Colors.RESET}")
        print(f"{Colors.BOLD}{Colors.CYAN}üîç M√ìDULO: {module_name.upper()}{Colors.RESET}")
        print(f"{Colors.CYAN}{'‚ïê'*70}{Colors.RESET}\n")
    
    def end_module(self, success: bool = True):
        """Finaliza visualiza√ß√£o de um m√≥dulo"""
        if self.silent:
            return
        
        if self.module_start_time:
            duration = (datetime.now() - self.module_start_time).total_seconds()
            status = f"{Colors.GREEN}‚úì{Colors.RESET}" if success else f"{Colors.RED}‚úó{Colors.RESET}"
            print(f"\n{status} M√≥dulo conclu√≠do em {duration:.2f}s\n")
    
    def print_step(self, step_name: str, status: str = "info"):
        """Imprime um passo do processo"""
        if self.silent:
            return
        
        icons = {
            "info": "‚Ñπ",
            "success": "‚úì",
            "warning": "‚ö†",
            "error": "‚úó",
            "running": "‚ü≥"
        }
        
        colors_map = {
            "info": Colors.BLUE,
            "success": Colors.GREEN,
            "warning": Colors.YELLOW,
            "error": Colors.RED,
            "running": Colors.CYAN
        }
        
        icon = icons.get(status, "‚Ä¢")
        color = colors_map.get(status, Colors.WHITE)
        
        print(f"{color}  {icon} {step_name}{Colors.RESET}")
    
    def print_table(self, headers: List[str], rows: List[List[str]], title: Optional[str] = None):
        """Imprime uma tabela formatada"""
        if self.silent:
            return
        
        if not rows:
            return
        
        if title:
            print(f"\n{Colors.BOLD}{Colors.CYAN}{title}{Colors.RESET}")
        
        # Calcular largura das colunas
        col_widths = [len(h) for h in headers]
        for row in rows:
            for i, cell in enumerate(row):
                if i < len(col_widths):
                    col_widths[i] = max(col_widths[i], len(str(cell)))
        
        # Adicionar padding
        col_widths = [w + 2 for w in col_widths]
        
        # Imprimir header
        header_line = "  " + " ‚îÇ ".join(h.ljust(col_widths[i]) for i, h in enumerate(headers))
        print(f"{Colors.BOLD}{Colors.CYAN}{header_line}{Colors.RESET}")
        print(f"  {'‚îÄ' * (sum(col_widths) + len(headers) * 3 - 1)}")
        
        # Imprimir rows
        for row in rows:
            row_line = "  " + " ‚îÇ ".join(str(cell).ljust(col_widths[i]) for i, cell in enumerate(row))
            print(row_line)
        
        print()
    
    def print_stats(self, stats: Dict[str, Any], title: str = "Estat√≠sticas"):
        """Imprime estat√≠sticas formatadas"""
        if self.silent:
            return
        
        print(f"\n{Colors.BOLD}{Colors.CYAN}üìä {title}{Colors.RESET}")
        print(f"{Colors.CYAN}{'‚îÄ'*50}{Colors.RESET}")
        
        for key, value in stats.items():
            if isinstance(value, (int, float)):
                color = Colors.GREEN if value > 0 else Colors.YELLOW
                print(f"  {Colors.BOLD}{key}:{Colors.RESET} {color}{value}{Colors.RESET}")
            elif isinstance(value, list):
                print(f"  {Colors.BOLD}{key}:{Colors.RESET} {Colors.CYAN}{len(value)} items{Colors.RESET}")
            else:
                print(f"  {Colors.BOLD}{key}:{Colors.RESET} {value}")
        
        print()
    
    def print_findings(self, findings: List[Dict[str, Any]], max_display: int = 10):
        """Imprime achados de forma formatada"""
        if self.silent or not findings:
            return
        
        print(f"\n{Colors.BOLD}{Colors.GREEN}üìã Achados ({len(findings)}):{Colors.RESET}")
        print(f"{Colors.GREEN}{'‚îÄ'*70}{Colors.RESET}")
        
        for i, finding in enumerate(findings[:max_display], 1):
            if isinstance(finding, dict):
                # Formato de vulnerabilidade
                if 'name' in finding:
                    severity = finding.get('severity', 'info').upper()
                    severity_colors = {
                        'CRITICAL': Colors.BRIGHT_RED,
                        'HIGH': Colors.RED,
                        'MEDIUM': Colors.YELLOW,
                        'LOW': Colors.GREEN,
                        'INFO': Colors.CYAN
                    }
                    color = severity_colors.get(severity, Colors.WHITE)
                    
                    print(f"  {Colors.BOLD}[{i}]{Colors.RESET} {color}[{severity}]{Colors.RESET} {finding.get('name', 'Unknown')}")
                    if finding.get('matched_at'):
                        print(f"      {Colors.DIM}‚Üí {finding['matched_at']}{Colors.RESET}")
                # Formato de URL/host
                elif 'url' in finding:
                    status = finding.get('status', '')
                    status_color = Colors.GREEN if status in ['200', '301', '302'] else Colors.YELLOW
                    print(f"  {Colors.BOLD}[{i}]{Colors.RESET} {finding['url']} {status_color}[{status}]{Colors.RESET}")
                else:
                    print(f"  {Colors.BOLD}[{i}]{Colors.RESET} {finding}")
            else:
                print(f"  {Colors.BOLD}[{i}]{Colors.RESET} {finding}")
        
        if len(findings) > max_display:
            remaining = len(findings) - max_display
            print(f"\n  {Colors.DIM}... e mais {remaining} achados{Colors.RESET}")
        
        print()
    
    def progress_bar(self, iterable, desc: str = "Progresso", total: Optional[int] = None):
        """Wrapper para progress bar do tqdm"""
        if self.silent:
            return iterable
        
        return tqdm(
            iterable,
            desc=f"{Colors.CYAN}{desc}{Colors.RESET}",
            total=total,
            ncols=80,
            bar_format='{l_bar}{bar}| {n_fmt}/{total_fmt} [{elapsed}<{remaining}]',
            file=sys.stdout
        )
    
    def print_summary_box(self, title: str, items: Dict[str, Any]):
        """Imprime um box de resumo"""
        if self.silent:
            return
        
        print(f"\n{Colors.CYAN}{'‚ïî' + '‚ïê'*68 + '‚ïó'}{Colors.RESET}")
        print(f"{Colors.CYAN}‚ïë{Colors.RESET} {Colors.BOLD}{title.center(68)}{Colors.RESET} {Colors.CYAN}‚ïë{Colors.RESET}")
        print(f"{Colors.CYAN}{'‚ï†' + '‚ïê'*68 + '‚ï£'}{Colors.RESET}")
        
        for key, value in items.items():
            if isinstance(value, (int, float)):
                color = Colors.GREEN if value > 0 else Colors.YELLOW
                line = f"‚ïë {Colors.BOLD}{key}:{Colors.RESET} {color}{value}{Colors.RESET}"
            elif isinstance(value, list):
                line = f"‚ïë {Colors.BOLD}{key}:{Colors.RESET} {Colors.CYAN}{len(value)} items{Colors.RESET}"
            else:
                line = f"‚ïë {Colors.BOLD}{key}:{Colors.RESET} {value}"
            
            # Padding para alinhar
            padding = 68 - len(line) + len(Colors.RESET) * 2 + len(Colors.BOLD) + len(Colors.CYAN) + len(Colors.GREEN) + len(Colors.YELLOW)
            print(f"{Colors.CYAN}{line}{' ' * padding}‚ïë{Colors.RESET}")
        
        print(f"{Colors.CYAN}{'‚ïö' + '‚ïê'*68 + '‚ïù'}{Colors.RESET}\n")
    
    def print_severity_summary(self, vulnerabilities: Dict[str, List]):
        """Imprime resumo de vulnerabilidades por severidade"""
        if self.silent:
            return
        
        total = sum(len(v) for v in vulnerabilities.values())
        
        if total == 0:
            print(f"\n{Colors.GREEN}‚úì Nenhuma vulnerabilidade encontrada{Colors.RESET}\n")
            return
        
        print(f"\n{Colors.BOLD}{Colors.YELLOW}‚ö† Vulnerabilidades Encontradas:{Colors.RESET}")
        print(f"{Colors.YELLOW}{'‚îÄ'*70}{Colors.RESET}")
        
        severity_order = ['critical', 'high', 'medium', 'low', 'info']
        severity_labels = {
            'critical': ('CRITICAL', Colors.BRIGHT_RED),
            'high': ('HIGH', Colors.RED),
            'medium': ('MEDIUM', Colors.YELLOW),
            'low': ('LOW', Colors.GREEN),
            'info': ('INFO', Colors.CYAN)
        }
        
        for sev in severity_order:
            if sev in vulnerabilities and vulnerabilities[sev]:
                count = len(vulnerabilities[sev])
                label, color = severity_labels[sev]
                bar_length = min(50, int((count / total) * 50))
                bar = '‚ñà' * bar_length
                print(f"  {color}{label:10}{Colors.RESET} {bar} {Colors.BOLD}{count}{Colors.RESET}")
        
        print()


def create_progress_display(silent: bool = False) -> ProgressDisplay:
    """Factory function para criar ProgressDisplay"""
    return ProgressDisplay(silent=silent)
