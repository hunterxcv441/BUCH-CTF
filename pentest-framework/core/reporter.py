"""
GeraÃ§Ã£o de relatÃ³rios em mÃºltiplos formatos.
"""

import json
from typing import Dict, Any
from pathlib import Path
from datetime import datetime
from jinja2 import Template

from core.utils import write_json, format_duration


class Reporter:
    """Gerencia geraÃ§Ã£o de relatÃ³rios"""
    
    def __init__(self, output_dir: Path):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True, parents=True)
    
    def generate_json(self, results: Dict[str, Any]):
        """Gera relatÃ³rio JSON"""
        output_file = self.output_dir / 'report.json'
        write_json(str(output_file), results, indent=2)
    
    def generate_html(self, results: Dict[str, Any]):
        """Gera relatÃ³rio HTML"""
        html_template = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pentest Report - {{ results.target }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .target {
            font-size: 1.3em;
            opacity: 0.9;
        }
        
        .meta {
            background: #f8f9fa;
            padding: 20px 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .meta-item {
            text-align: center;
        }
        
        .meta-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .meta-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }
        
        .content {
            padding: 40px;
        }
        
        .module {
            margin-bottom: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .module-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .module-content {
            padding: 20px;
        }
        
        .vulnerability {
            margin-bottom: 20px;
            padding: 15px;
            border-left: 4px solid;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .vuln-critical {
            border-color: #dc3545;
            background: #ffe6e6;
        }
        
        .vuln-high {
            border-color: #ff6b6b;
            background: #fff0f0;
        }
        
        .vuln-medium {
            border-color: #ffc107;
            background: #fff8e1;
        }
        
        .vuln-low {
            border-color: #28a745;
            background: #e8f5e9;
        }
        
        .vuln-info {
            border-color: #17a2b8;
            background: #e3f2fd;
        }
        
        .vuln-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .vuln-severity {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .severity-critical {
            background: #dc3545;
            color: white;
        }
        
        .severity-high {
            background: #ff6b6b;
            color: white;
        }
        
        .severity-medium {
            background: #ffc107;
            color: #333;
        }
        
        .severity-low {
            background: #28a745;
            color: white;
        }
        
        .severity-info {
            background: #17a2b8;
            color: white;
        }
        
        .list {
            list-style: none;
            padding: 0;
        }
        
        .list-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item::before {
            content: "â†’";
            color: #667eea;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”’ Penetration Test Report</h1>
            <p class="target">{{ results.target }}</p>
        </div>
        
        <div class="meta">
            <div class="meta-item">
                <div class="meta-label">Start Time</div>
                <div class="meta-value">{{ results.start_time.split('T')[0] }}</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Duration</div>
                <div class="meta-value">{{ "%.2f"|format(results.duration) }}s</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">Modules</div>
                <div class="meta-value">{{ results.modules|length }}</div>
            </div>
        </div>
        
        <div class="content">
            <h2 style="margin-bottom: 20px;">ðŸ“Š Summary</h2>
            <div class="summary-grid">
                {% if results.modules.subdomain %}
                <div class="summary-card">
                    <h3>{{ results.modules.subdomain.subdomains|length }}</h3>
                    <p>Subdomains</p>
                </div>
                {% endif %}
                
                {% if results.modules.ports %}
                <div class="summary-card">
                    <h3>{{ results.modules.ports.ports|length }}</h3>
                    <p>Open Ports</p>
                </div>
                {% endif %}
                
                {% if results.modules.crawl %}
                <div class="summary-card">
                    <h3>{{ results.modules.crawl.urls|length }}</h3>
                    <p>URLs Found</p>
                </div>
                {% endif %}
                
                {% if results.modules.vulnerabilities %}
                {% set vuln_count = results.modules.vulnerabilities.critical|length + results.modules.vulnerabilities.high|length + results.modules.vulnerabilities.medium|length %}
                <div class="summary-card">
                    <h3>{{ vuln_count }}</h3>
                    <p>Vulnerabilities</p>
                </div>
                {% endif %}
            </div>
            
            {% for module_name, module_data in results.modules.items() %}
            <div class="module">
                <div class="module-header">{{ module_name.upper() }}</div>
                <div class="module-content">
                    {% if module_name == 'vulnerabilities' %}
                        {% for severity in ['critical', 'high', 'medium', 'low', 'info'] %}
                            {% if module_data[severity] %}
                                <h3 style="margin-top: 20px; margin-bottom: 10px;">{{ severity.upper() }} ({{ module_data[severity]|length }})</h3>
                                {% for vuln in module_data[severity] %}
                                <div class="vulnerability vuln-{{ severity }}">
                                    <div class="vuln-title">
                                        {{ vuln.name }}
                                        <span class="vuln-severity severity-{{ severity }}">{{ severity.upper() }}</span>
                                    </div>
                                    <p style="margin-top: 10px; color: #666;">
                                        <strong>Matched at:</strong> {{ vuln.matched_at }}<br>
                                        <strong>Template:</strong> {{ vuln.template }}
                                    </p>
                                    {% if vuln.description %}
                                    <p style="margin-top: 10px;">{{ vuln.description }}</p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    
                    {% elif module_name == 'subdomain' %}
                        <h3>Subdomains ({{ module_data.subdomains|length }})</h3>
                        <ul class="list">
                        {% for subdomain in module_data.subdomains[:50] %}
                            <li class="list-item">{{ subdomain }}</li>
                        {% endfor %}
                        {% if module_data.subdomains|length > 50 %}
                            <li class="list-item" style="color: #666; font-style: italic;">... and {{ module_data.subdomains|length - 50 }} more</li>
                        {% endif %}
                        </ul>
                        
                        {% if module_data.active %}
                        <h3 style="margin-top: 20px;">Active Hosts ({{ module_data.active|length }})</h3>
                        <ul class="list">
                        {% for host in module_data.active[:30] %}
                            <li class="list-item">
                                {{ host.url }}
                                <span class="badge">{{ host.status }}</span>
                                {% if host.title %}
                                <span style="color: #666; margin-left: 10px;">{{ host.title }}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                        {% endif %}
                    
                    {% elif module_name == 'ports' %}
                        <h3>Open Ports ({{ module_data.ports|length }})</h3>
                        <ul class="list">
                        {% for port in module_data.ports %}
                            <li class="list-item">
                                <strong>{{ port.port }}/{{ port.protocol }}</strong>
                                <span class="badge">{{ port.service }}</span>
                                {% if port.version %}
                                <span style="color: #666; margin-left: 10px;">{{ port.version }}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    
                    {% elif module_name == 'crawl' %}
                        <h3>URLs Found ({{ module_data.urls|length }})</h3>
                        <ul class="list">
                        {% for url in module_data.urls[:100] %}
                            <li class="list-item">{{ url }}</li>
                        {% endfor %}
                        {% if module_data.urls|length > 100 %}
                            <li class="list-item" style="color: #666; font-style: italic;">... and {{ module_data.urls|length - 100 }} more</li>
                        {% endif %}
                        </ul>
                    
                    {% elif module_name == 'recon' %}
                        {% if module_data.technologies %}
                        <h3>Technologies Detected</h3>
                        <ul class="list">
                        {% for tech in module_data.technologies %}
                            <li class="list-item">{{ tech }}</li>
                        {% endfor %}
                        </ul>
                        {% endif %}
                        
                        {% if module_data.server %}
                        <p style="margin-top: 20px;"><strong>Server:</strong> {{ module_data.server }}</p>
                        {% endif %}
                    
                    {% else %}
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto;">{{ module_data|tojson(indent=2) }}</pre>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="footer">
            <p>Generated by BUCH Pentest Framework v1.0</p>
            <p style="margin-top: 5px; font-size: 0.9em;">{{ results.end_time }}</p>
        </div>
    </div>
</body>
</html>
        """
        
        template = Template(html_template)
        html_content = template.render(results=results)
        
        output_file = self.output_dir / 'report.html'
        output_file.write_text(html_content, encoding='utf-8')
    
    def generate_pdf(self, results: Dict[str, Any]):
        """Gera relatÃ³rio PDF"""
        try:
            from reportlab.lib.pagesizes import letter, A4
            from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
            from reportlab.lib.units import inch
            from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak, Table, TableStyle
            from reportlab.lib import colors
            
            output_file = self.output_dir / 'report.pdf'
            doc = SimpleDocTemplate(str(output_file), pagesize=A4)
            
            styles = getSampleStyleSheet()
            story = []
            
            # Title
            title_style = ParagraphStyle(
                'CustomTitle',
                parent=styles['Heading1'],
                fontSize=24,
                textColor=colors.HexColor('#667eea'),
                spaceAfter=30,
                alignment=1  # Center
            )
            
            story.append(Paragraph("Penetration Test Report", title_style))
            story.append(Paragraph(f"Target: {results['target']}", styles['Heading2']))
            story.append(Spacer(1, 0.3*inch))
            
            # Metadata
            meta_data = [
                ['Start Time', results['start_time']],
                ['Duration', f"{results['duration']:.2f}s"],
                ['Modules', str(len(results['modules']))]
            ]
            
            meta_table = Table(meta_data, colWidths=[2*inch, 4*inch])
            meta_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (0, -1), colors.grey),
                ('TEXTCOLOR', (0, 0), (0, -1), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, -1), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, -1), 10),
                ('BOTTOMPADDING', (0, 0), (-1, -1), 12),
                ('GRID', (0, 0), (-1, -1), 1, colors.black)
            ]))
            
            story.append(meta_table)
            story.append(Spacer(1, 0.5*inch))
            
            # Modules
            for module_name, module_data in results['modules'].items():
                story.append(Paragraph(f"{module_name.upper()}", styles['Heading2']))
                story.append(Spacer(1, 0.2*inch))
                
                # Add module-specific content
                if isinstance(module_data, dict):
                    for key, value in module_data.items():
                        if isinstance(value, list) and value:
                            story.append(Paragraph(f"{key}: {len(value)} items", styles['Normal']))
                
                story.append(Spacer(1, 0.3*inch))
            
            doc.build(story)
            
        except ImportError:
            raise RuntimeError("reportlab nÃ£o instalado. Instale com: pip install reportlab")
    
    def generate_markdown(self, results: Dict[str, Any]):
        """Gera relatÃ³rio Markdown"""
        output_file = self.output_dir / 'report.md'
        
        md_content = f"""# Penetration Test Report

## Target Information
- **Target**: {results['target']}
- **Start Time**: {results['start_time']}
- **Duration**: {results.get('duration', 0):.2f}s
- **Modules**: {len(results['modules'])}

---

"""
        
        # Add modules
        for module_name, module_data in results['modules'].items():
            md_content += f"## {module_name.upper()}\n\n"
            
            if isinstance(module_data, dict):
                for key, value in module_data.items():
                    if isinstance(value, list):
                        md_content += f"### {key} ({len(value)})\n\n"
                        for item in value[:20]:  # Limit items
                            md_content += f"- {item}\n"
                        if len(value) > 20:
                            md_content += f"- ... and {len(value) - 20} more\n"
                        md_content += "\n"
            
            md_content += "---\n\n"
        
        md_content += f"\n*Generated by BUCH Pentest Framework v1.0*\n"
        
        output_file.write_text(md_content, encoding='utf-8')

